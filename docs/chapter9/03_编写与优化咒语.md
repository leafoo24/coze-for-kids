# ç¬¬ä¹ç«  - å…³å¡3ï¼šç¼–å†™ä¸ä¼˜åŒ–å’’è¯­â€”â€”è®©å“ªå’æ–½å±•å®Œç¾æ³•æœ¯

## å¤©åº­æŒ‘æˆ˜ï¼šé¾™ç‹çš„å¤©æ°”è€ƒéªŒ

> "é£äº‘å˜å¹»ï¼Œä¸‡é‡Œæ±Ÿå±±ï¼ŒåŒ—äº¬ä¸æ˜¯110100ï¼Œè€Œæ˜¯'åŒ—äº¬'ï¼Œå¦‚ä½•è®©å¤©æ°”ç¥é€šæ˜ç™½å‡¡äººä¹‹è¯­ï¼Ÿ" â€”â€” å¤ªä¹™çœŸäººçš„è€ƒé¢˜

å“ªå’å¥‰å¸ˆçˆ¶å¤ªä¹™çœŸäººä¹‹å‘½ï¼Œæ”¶é›†å„åœ°å¤©è±¡ä»¥åº”å¯¹å››æµ·é¾™ç‹çš„æš´é›¨å¤©ç¾ã€‚æ¥åˆ°ä¸œæµ·é¾™å®«åï¼Œå“ªå’é‡åˆ°äº†ä¸¤ä¸ªå…³é”®æŒ‘æˆ˜ï¼š

1. **å‡¡è¯­ä¸å¤©åº­å¯†ç ä¸é€š**ï¼šäººé—´ç™¾å§“è¯´"åŒ—äº¬å¤©æ°”"ï¼Œè€Œé"110100å¤©æ°”"
2. **ç¥é€šå°šæœªç²¾ç‚¼**ï¼šé¾™å®«æ°´æ™¶çƒèƒ½æ˜¾ç¤ºå®Œç¾å¤©æ°”å›¾ï¼Œè€Œå“ªå’çš„ç¥é€šæ˜¾ç¤ºä¸€å †å‡Œä¹±æ•°æ®

> **ä¸œæµ·é¾™ç‹**ï¼ˆåŒæ‰‹æŠ±èƒ¸ï¼‰ï¼š"å“ªå’ï¼Œå¤ªä¹™çœŸäººè¯´ä½ æŒæ¡äº†è§‚å¤©æµ‹åœ°çš„ç¥é€šï¼Ÿæˆ‘ä¸”è€ƒæ ¡ä¸€ç•ªï¼"
>
> **å“ªå’**ï¼ˆä¿¡å¿ƒæ»¡æ»¡ï¼‰ï¼š"é¾™ç‹è¯·è¯´ï¼Œæˆ‘å®šä¸è´Ÿå¸ˆçˆ¶æ‰€æœ›ï¼"
>
> **é¾™ç‹**ï¼š"å‘Šè¯‰æˆ‘ä¸œæµ·ä»Šæ—¥å¤©è±¡å¦‚ä½•ï¼Ÿ"

å“ªå’æ€¥å¿™æ–½æ³•ï¼Œå´è§æ³•å®é—ªçƒä¸å®šï¼Œæœ€ç»ˆæ˜¾ç¤ºï¼š"æœªè¯†åˆ«'ä¸œæµ·'åœ°ç‚¹"ï¼é¾™ç‹çœ‰å¤´ä¸€çš±ï¼š"å°±è¿™ï¼Ÿ"å“ªå’é¡¿æ—¶æ±—å¦‚é›¨ä¸‹...

æ˜¯æ—¶å€™å¼•å…¥ä½¿ç”¨è½¬åŒ–å¤§æ³•çš„å¥‡å¦™ç‰¹æ€§äº†â€”â€”å°†å‡¡è¯­è½¬åŒ–ä¸ºå¤©åº­å¯†ç ï¼Œå¹¶å°†æ‚ä¹±ä¿¡æ¯åŒ–ä¸ºæ¸…æ™°å›¾åƒï¼

## ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯­è¨€è½¬åŒ–ä¹‹æœ¯

### è½¬åŒ–å¤§æ³•çš„ç§˜å¯†

åœ¨ä»£ç ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥èµ‹äºˆæ³•å®"è¯­è¨€è½¬åŒ–"çš„èƒ½åŠ›ï¼Œè®©å®ƒè‡ªåŠ¨å°†åŸå¸‚åè½¬ä¸ºåŸå¸‚ç¼–ç ã€‚

![è½¬åŒ–å¤§æ³•](img/03_ç¼–å†™ä¸ä¼˜åŒ–å’’è¯­/hun_tian_ling_concept.png)

### ä¸‰é‡ç¥é€šä¿®ç‚¼

#### ä¸€é‡ï¼šå»ºç«‹"å¤©åœ°åå†Œ"â€”â€”åŸå¸‚åä¸ç¼–ç å¯¹åº”

è½¬åŒ–å¤§æ³•éœ€è¦ä¸€ä¸ª"å¤©ä¸‹åœ°åå½•"ï¼Œè®°è½½å…¨å›½åŸæ± ä¸å…¶å¯†ç å¯¹åº”å…³ç³»ï¼š

```python
# æ··å¤©ç»«å¤©åœ°åå†Œ - åŸæ± åç§°ä¸å¤©åº­å¯†ç å¯¹åº”
city_map = {
    'åŒ—äº¬': 110100,
    'ä¸Šæµ·': 310100,
    'å¹¿å·': 440100,
    'æ·±åœ³': 440300,
    'æ­å·': 330100,
    # å¯æ·»åŠ æ›´å¤šåŸæ± ...
}

# ä»™å¢ƒåå†Œ - ç¥è¯åœ°ç‚¹çš„ç‰¹æ®Šæ˜ å°„
immortal_places = {
    'ä¸œæµ·': 110100,  # ä¸œæµ·é¾™å®«ç”¨åŒ—äº¬çš„å¤©æ°”
    'è¥¿æµ·': 310100,  # è¥¿æµ·é¾™å®«ç”¨ä¸Šæµ·çš„å¤©æ°”
    'å—æµ·': 440100,  # å—æµ·é¾™å®«ç”¨å¹¿å·çš„å¤©æ°”
    'åŒ—æµ·': 330100,  # åŒ—æµ·é¾™å®«ç”¨æ­å·çš„å¤©æ°”
    'é¾™å®«': 440300,  # é¾™å®«æ€»éƒ¨ç”¨æ·±åœ³çš„å¤©æ°”
}
```

#### äºŒé‡ï¼šè®¾è®¡"è®¤å­—è¯€"â€”â€”åŸå¸‚åè§„èŒƒåŒ–

æ··å¤©ç»«çš„"è®¤å­—è¯€"èƒ½å¤Ÿå¤„ç†å„ç§ä¸è§„èŒƒçš„ç§°å‘¼ï¼Œå¦‚"åŒ—äº¬å¸‚"â†’"åŒ—äº¬"ï¼š

```python
def purify_mortal_speech(name: str) -> str:
    """è½¬åŒ–å¤§æ³•ï¼šå‡€åŒ–å‡¡äººè¨€è¯­ï¼Œè¯†åˆ«çœŸæ­£åœ°å"""
    if not name:
        return ""
    
    # é™¤å»"å¸‚"å­—ç­‰å‡¡é—´è¡Œæ”¿å•ä½åç¼€
    name = name.replace('å¸‚', '').replace('å¿', '').strip()
    
    # å¤„ç†å¸¸è§åˆ«ç§°ä¸å£è¯¯
    name_corrections = {
        'å¸éƒ½': 'åŒ—äº¬',
        'é­”éƒ½': 'ä¸Šæµ·',
        'ç¾ŠåŸ': 'å¹¿å·',
        'é¹åŸ': 'æ·±åœ³',
        'æ­æ´²': 'æ­å·',  # å¸¸è§æ‹¼å†™é”™è¯¯
    }
    
    return name_corrections.get(name, name)
```

#### ä¸‰é‡ï¼šç¼–å†™"é€šå¤©æœ¯"â€”â€”åŸå¸‚åè½¬æ¢å‡½æ•°

"é€šå¤©æœ¯"èƒ½å°†å‡¡äººè¯­è¨€è½¬ä¸ºå¤©åº­å¯†ç ï¼š

```python
def translate_mortal_to_heaven(city_name: str):
    """é€šå¤©æœ¯ï¼šå°†å‡¡é—´åœ°åè½¬ä¸ºå¤©åº­å¯†ç """
    print(f"æ­£åœ¨è§£æå‡¡é—´åœ°åï¼š{city_name}")
    pure_name = purify_mortal_speech(city_name)
    print(f"å‡€åŒ–ååœ°åï¼š{pure_name}")
    
    # å…ˆæŸ¥æ‰¾ä»™å¢ƒåå†Œ
    if pure_name in immortal_places:
        district_id = immortal_places[pure_name]
        print(f"è¯†åˆ«ä¸ºä»™å¢ƒåœ°ç‚¹ï¼š{pure_name}ï¼Œå¯¹åº”å¯†ç ï¼š{district_id}")
        return district_id
        
    # å†æŸ¥æ‰¾æ™®é€šåŸæ± 
    if pure_name in city_map:
        district_id = city_map[pure_name]
        print(f"è¯†åˆ«ä¸ºå‡¡é—´åŸæ± ï¼š{pure_name}ï¼Œå¯¹åº”å¯†ç ï¼š{district_id}")
        return district_id
        
    # æ— æ³•è¯†åˆ«çš„åœ°å
    print(f"è­¦ç¤ºï¼šæœªèƒ½è¯†åˆ«æ­¤åœ°åï¼š{pure_name}")
    return None
```

## ç¬¬äºŒéƒ¨åˆ†ï¼šä¿¡æ¯æç‚¼â€”â€”ä»æ‚ä¹±åˆ°ç²¾å

### ä¿¡æ¯æç‚¼çš„å¦™ç”¨

å“ªå’ä½¿ç”¨ä¿¡æ¯æç‚¼ç²¾å‡†æå–å…³é”®ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬çš„å¤©æ°”æ³•æœ¯ä¸­ï¼Œå¯ä»¥ä»å¤æ‚çš„APIè¿”å›æ•°æ®ä¸­ï¼Œæå–å‡ºæœ€é‡è¦çš„å¤©æ°”ä¿¡æ¯ã€‚

![æå–ç²¾å](img/03_ç¼–å†™ä¸ä¼˜åŒ–å’’è¯­/qian_kun_quan_concept.png)

### ä¸‰çº§ç²¾ç‚¼æœ¯

#### ä¸€çº§ï¼šä¿¡æ¯æ¢æŸ¥â€”â€”æ”¶é›†åŸå§‹æ•°æ®

```python
def handler(args: Args[Input]) -> Output:
    # ...existing code...
    
    try:
        # ä½¿ç”¨ç¥é€šè”ç³»å¤©åº­æ°”è±¡å°
        print(f"æ­£åœ¨ä¼ é€è‡³å¤©åº­æ°”è±¡å°...")
        response = requests.get(url=url, params=params)
        response.raise_for_status()
        raw_data = response.json()
        print(f"æˆåŠŸè·å–å¤©è±¡å·è½´ï¼çŠ¶æ€ï¼š{raw_data.get('status', 'æœªçŸ¥')}")
        
        
```

#### äºŒçº§ï¼šä¿¡æ¯æç‚¼â€”â€”é€‰å–å…³é”®æ•°æ®

```python
# ä½¿ç”¨ä¹¾å¤åœˆæç‚¼å¤©è±¡ä¿¡æ¯
print(f"æ­£åœ¨æç‚¼å¤©è±¡ç²¾å...")
result = raw_data.get("result", {})
location = result.get("location", {})
current = result.get("now", {})
forecasts = result.get("forecasts", [])

# ç²¾é€‰ä¿¡æ¯
weather_essence = {
    "åŸæ± ": location.get('name', city_name),
    "æ°”æ¸©": f"{current.get('temp', 'N/A')}Â°C",
    "å¤©è±¡": current.get('text', 'N/A'),
    "é£å‘": current.get('wind_dir', 'N/A'),
    "é£åŠ›": current.get('wind_class', 'N/A'),
    "æ¹¿åº¦": f"{current.get('rh', 'N/A')}%",
    "é¢„æµ‹": []
}

# æ·»åŠ æœªæ¥å¤©è±¡é¢„æµ‹
print(f"æ­£åœ¨è§£ææœªæ¥{len(forecasts)}æ—¥å¤©è±¡...")
for forecast in forecasts:
    future_weather = {
        "æ—¥æœŸ": forecast.get('date'),
        "æ˜ŸæœŸ": forecast.get('week'),
        "æ—¥é—´å¤©è±¡": forecast.get('text_day'),
        "å¤œé—´å¤©è±¡": forecast.get('text_night'),
        "æœ€é«˜æ¸©": forecast.get('high'),
        "æœ€ä½æ¸©": forecast.get('low'),
        "æ—¥é—´é£å‘": forecast.get('wd_day'),
        "æ—¥é—´é£åŠ›": forecast.get('wc_day')
    }
    weather_essence["é¢„æµ‹"].append(future_weather)
```

#### ä¸‰çº§ï¼šä¿¡æ¯ç¾åŒ–â€”â€”åä¸½å±•ç¤º

åœ¨æˆ‘ä»¬çš„æ’ä»¶ä¸­ï¼Œéœ€è¦å°†å¤©æ°”ä¿¡æ¯å˜å¾—ç¾è§‚æ˜“è¯»ï¼š

```python
def create_celestial_weather_scroll(weather_essence):
    """å¤©è±¡å›¾ï¼šå°†å¤©æ°”ä¿¡æ¯åŒ–ä¸ºåç¾å·è½´"""
    
    # å¤©è±¡å¯¹åº”çµç¬¦
    celestial_symbols = {
        "æ™´": "â˜€ï¸ å¤ªé˜³å½“ç©º",
        "å¤šäº‘": "â›… äº‘é®è–„æ—¥",
        "é˜´": "â˜ï¸ é˜´äº‘å¯†å¸ƒ",
        "é›¨": "ğŸŒ§ï¸ é›¨è½å‡¡å°˜",
        "é›ª": "â„ï¸ ç‘é›ªçº·é£",
        "é›·": "âš¡ é›·éœ†ä¸‡é’§",
        "é›¾": "ğŸŒ«ï¸ äº‘é›¾ç¼­ç»•"
    }
    
    # è·å–å½“å‰å¤©è±¡çµç¬¦
    current_weather = weather_essence["å¤©è±¡"]
    symbol = "ğŸŒˆ å¤©è±¡å¥‡å˜"  # é»˜è®¤çµç¬¦
    
    for weather_type, symbol_text in celestial_symbols.items():
        if weather_type in current_weather:
            symbol = symbol_text
            break
    
    # ç»˜åˆ¶å¤©è±¡å·è½´
    scroll = f"""
â•”â•â•â•â•â•â•â•â•â•â•ã€ {weather_essence['åŸæ± ']}å¤©è±¡é¢„æŠ¥ ã€â•â•â•â•â•â•â•â•â•â•â•—

  {symbol}
  ğŸŒ¡ï¸ æ°”æ¸©: {weather_essence['æ°”æ¸©']}
  ğŸ’§ æ¹¿åº¦: {weather_essence['æ¹¿åº¦']}
  ğŸƒ é£å‘: {weather_essence['é£å‘']} {weather_essence['é£åŠ›']}

â• â•â•â•â•â•â•â•â•â•â•ã€ æœªæ¥å¤©è±¡é¢„æµ‹ ã€â•â•â•â•â•â•â•â•â•â•â•£
"""
    
    # æ·»åŠ æœªæ¥å¤©è±¡é¢„æµ‹
    for i, forecast in enumerate(weather_essence['é¢„æµ‹']):
        if i >= 3:  # åªæ˜¾ç¤ºä¸‰å¤©é¢„æŠ¥
            break
            
        # å¯»æ‰¾åˆé€‚çš„çµç¬¦
        day_symbol = "ğŸŒˆ"
        for weather_type, symbol_text in celestial_symbols.items():
            if weather_type in forecast['æ—¥é—´å¤©è±¡']:
                day_symbol = symbol_text.split()[0]  # åªå–ç¬¦å·éƒ¨åˆ†
                break
        
        scroll += f"""
  {forecast['æ—¥æœŸ']} ({forecast['æ˜ŸæœŸ']})ï¼š
  {day_symbol} ç™½æ—¥: {forecast['æ—¥é—´å¤©è±¡']} {forecast['æœ€é«˜æ¸©']}Â°C
  ğŸŒ™ å¤œæ™š: {forecast['å¤œé—´å¤©è±¡']} {forecast['æœ€ä½æ¸©']}Â°C
  ğŸƒ é£åŠ¿: {forecast['æ—¥é—´é£å‘']} {forecast['æ—¥é—´é£åŠ›']}
"""
    
    # å“ªå’æé†’
    scroll += "\nâ• â•â•â•â•â•â•â•â•â•â•ã€ å“ªå’æé†’ ã€â•â•â•â•â•â•â•â•â•â•â•£\n"
    
    if 'é›¨' in current_weather:
        scroll += "\n  ğŸŒ‚ å¸¦å¥½é›¨ä¼ï¼Œè°¨é˜²æ·‹æ¹¿ï¼"
    elif 'é›ª' in current_weather:
        scroll += "\n  ğŸ§¤ æ³¨æ„ä¿æš–ï¼Œå°å¿ƒè·¯æ»‘ï¼"
    elif int(weather_essence['æ°”æ¸©'].replace('Â°C', '')) > 30:
        scroll += "\n  ğŸ¥µ å¤©æ°”ç‚çƒ­ï¼Œæ³¨æ„é˜²æš‘ï¼"
    elif int(weather_essence['æ°”æ¸©'].replace('Â°C', '')) < 5:
        scroll += "\n  ğŸ§£ å¤©å¯’åœ°å†»ï¼Œæ·»è¡£ä¿æš–ï¼"
    else:
        scroll += "\n  ğŸŒ å¤©æ°”å®œäººï¼Œé€‚åˆå‡ºè¡Œï¼"
    
    scroll += "\n\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    return scroll
```

## å®Œæ•´å¤©æ°”ç¥é€šâ€”â€”ä¸‰å¤§æ³•å®åˆåŠ›

å“ªå’çš„å®Œæ•´å¤©æ°”ç¥é€šä»£ç å¦‚ä¸‹ï¼š

```python
from runtime import Args
import requests
from typings.weather.weather import Input, Output

# å¤©åœ°åå†Œ - åŸæ± åç§°ä¸å¤©åº­å¯†ç å¯¹åº”
city_map = {
    'åŒ—äº¬': 110100,
    'ä¸Šæµ·': 310100,
    'å¹¿å·': 440100,
    'æ·±åœ³': 440300,
    'æ­å·': 330100,
    'æˆéƒ½': 510100,
    'é‡åº†': 500100,
    'æ­¦æ±‰': 420100,
    'è¥¿å®‰': 610100,
    'å—äº¬': 320100
}

# ä»™å¢ƒåå†Œ - ç¥è¯åœ°ç‚¹çš„ç‰¹æ®Šæ˜ å°„
immortal_places = {
    'ä¸œæµ·': 310100,      # ä¸œæµ·é¾™å®«ç”¨ä¸Šæµ·çš„å¤©æ°”
    'è¥¿æµ·': 610100,      # è¥¿æµ·é¾™å®«ç”¨è¥¿å®‰çš„å¤©æ°”
    'å—æµ·': 440100,      # å—æµ·é¾™å®«ç”¨å¹¿å·çš„å¤©æ°”
    'åŒ—æµ·': 110100,      # åŒ—æµ·é¾™å®«ç”¨åŒ—äº¬çš„å¤©æ°”
    'é¾™å®«': 310100,      # é¾™å®«æ€»éƒ¨ç”¨ä¸Šæµ·çš„å¤©æ°”
    'èŠ±æœå±±': 320100,    # èŠ±æœå±±ç”¨å—äº¬çš„å¤©æ°”
    'å¤©åº­': 110100,      # å¤©åº­ç”¨åŒ—äº¬çš„å¤©æ°”
    'çµå±±': 500100,      # çµå±±ç”¨é‡åº†çš„å¤©æ°”
    'ä¸œèƒœç¥å·': 510100   # ä¸œèƒœç¥å·ç”¨æˆéƒ½çš„å¤©æ°”
}

def purify_mortal_speech(name: str) -> str:
    """è®¤å­—è¯€ï¼šå‡€åŒ–å‡¡äººè¨€è¯­ï¼Œè¯†åˆ«çœŸæ­£åœ°å"""
    if not name:
        return ""
    
    # é™¤å»"å¸‚"å­—ç­‰å‡¡é—´è¡Œæ”¿å•ä½åç¼€
    name = name.replace('å¸‚', '').replace('å¿', '').replace('åŒº', '').strip()
    
    # å¤„ç†å¸¸è§åˆ«ç§°ä¸å£è¯¯
    name_corrections = {
        'å¸éƒ½': 'åŒ—äº¬',
        'é­”éƒ½': 'ä¸Šæµ·',
        'ç¾ŠåŸ': 'å¹¿å·',
        'é¹åŸ': 'æ·±åœ³',
        'æ­æ´²': 'æ­å·',  # å¸¸è§æ‹¼å†™é”™è¯¯
        'è“‰åŸ': 'æˆéƒ½',
        'æ¸åŸ': 'é‡åº†',
        'æ±‰å£': 'æ­¦æ±‰',
        'é•¿å®‰': 'è¥¿å®‰',
        'é‡‘é™µ': 'å—äº¬'
    }
    
    return name_corrections.get(name, name)

def create_celestial_weather_scroll(weather_essence):
    """ç«å°–æªå¤©è±¡å›¾ï¼šå°†å¤©æ°”ä¿¡æ¯åŒ–ä¸ºåç¾å·è½´"""
    
    # å¤©è±¡å¯¹åº”çµç¬¦
    celestial_symbols = {
        "æ™´": "â˜€ï¸ å¤ªé˜³å½“ç©º",
        "å¤šäº‘": "â›… äº‘é®è–„æ—¥",
        "é˜´": "â˜ï¸ é˜´äº‘å¯†å¸ƒ",
        "é›¨": "ğŸŒ§ï¸ é›¨è½å‡¡å°˜",
        "é›ª": "â„ï¸ ç‘é›ªçº·é£",
        "é›·": "âš¡ é›·éœ†ä¸‡é’§",
        "é›¾": "ğŸŒ«ï¸ äº‘é›¾ç¼­ç»•"
    }
    
    # è·å–å½“å‰å¤©è±¡çµç¬¦
    current_weather = weather_essence["å¤©è±¡"]
    symbol = "ğŸŒˆ å¤©è±¡å¥‡å˜"  # é»˜è®¤çµç¬¦
    
    for weather_type, symbol_text in celestial_symbols.items():
        if weather_type in current_weather:
            symbol = symbol_text
            break
    
    # ç«å°–æªç»˜åˆ¶å¤©è±¡å·è½´
    scroll = f"""
â•”â•â•â•â•â•â•â•â•â•â•ã€ {weather_essence['åŸæ± ']}å¤©è±¡é¢„æŠ¥ ã€â•â•â•â•â•â•â•â•â•â•â•—

  {symbol}
  ğŸŒ¡ï¸ æ°”æ¸©: {weather_essence['æ°”æ¸©']}
  ğŸ’§ æ¹¿åº¦: {weather_essence['æ¹¿åº¦']}
  ğŸƒ é£å‘: {weather_essence['é£å‘']} {weather_essence['é£åŠ›']}

â• â•â•â•â•â•â•â•â•â•â•ã€ æœªæ¥å¤©è±¡é¢„æµ‹ ã€â•â•â•â•â•â•â•â•â•â•â•£
"""
    
    # æ·»åŠ æœªæ¥å¤©è±¡é¢„æµ‹
    for i, forecast in enumerate(weather_essence['é¢„æµ‹']):
        if i >= 3:  # åªæ˜¾ç¤ºä¸‰å¤©é¢„æŠ¥
            break
            
        # å¯»æ‰¾åˆé€‚çš„çµç¬¦
        day_symbol = "ğŸŒˆ"
        for weather_type, symbol_text in celestial_symbols.items():
            if weather_type in forecast['æ—¥é—´å¤©è±¡']:
                day_symbol = symbol_text.split()[0]  # åªå–ç¬¦å·éƒ¨åˆ†
                break
        
        scroll += f"""
  {forecast['æ—¥æœŸ']} ({forecast['æ˜ŸæœŸ']})ï¼š
  {day_symbol} ç™½æ—¥: {forecast['æ—¥é—´å¤©è±¡']} {forecast['æœ€é«˜æ¸©']}Â°C
  ğŸŒ™ å¤œæ™š: {forecast['å¤œé—´å¤©è±¡']} {forecast['æœ€ä½æ¸©']}Â°C
  ğŸƒ é£åŠ¿: {forecast['æ—¥é—´é£å‘']} {forecast['æ—¥é—´é£åŠ›']}
"""
    
    # å“ªå’æé†’
    scroll += "\nâ• â•â•â•â•â•â•â•â•â•â•ã€ å“ªå’æé†’ ã€â•â•â•â•â•â•â•â•â•â•â•£\n"
    
    if 'é›¨' in current_weather:
        scroll += "\n  ğŸŒ‚ å¸¦å¥½é›¨ä¼ï¼Œè°¨é˜²æ·‹æ¹¿ï¼"
    elif 'é›ª' in current_weather:
        scroll += "\n  ğŸ§¤ æ³¨æ„ä¿æš–ï¼Œå°å¿ƒè·¯æ»‘ï¼"
    elif int(weather_essence['æ°”æ¸©'].replace('Â°C', '')) > 30:
        scroll += "\n  ğŸ¥µ å¤©æ°”ç‚çƒ­ï¼Œæ³¨æ„é˜²æš‘ï¼"
    elif int(weather_essence['æ°”æ¸©'].replace('Â°C', '')) < 5:
        scroll += "\n  ğŸ§£ å¤©å¯’åœ°å†»ï¼Œæ·»è¡£ä¿æš–ï¼"
    else:
        scroll += "\n  ğŸŒ å¤©æ°”å®œäººï¼Œé€‚åˆå‡ºè¡Œï¼"
    
    scroll += "\n\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    return scroll

def handler(args: Args[Input]) -> Output:
    """å“ªå’å¤©æ°”ç¥é€šä¸»æ³•æœ¯"""
    print(f"ã€å“ªå’ã€‘æ”¶åˆ°æŸ¥è¯¢è¯·æ±‚ï¼š{args.input.city_name}")
    
    # 1. è¯­è¨€è½¬åŒ–
    city_name = purify_mortal_speech(args.input.city_name)
    print(f" å‡€åŒ–ååœ°åï¼š{city_name}")
    
    # 2. è¯†åˆ«åœ°ç‚¹ç±»å‹
    district_id = None
    
    if city_name in immortal_places:
        district_id = immortal_places[city_name]
        print(f" è¯†åˆ«ä¸ºä»™å¢ƒåœ°ç‚¹ï¼š{city_name}ï¼Œå¯¹åº”å¯†ç ï¼š{district_id}")
    elif city_name in city_map:
        district_id = city_map[city_name]
        print(f" è¯†åˆ«ä¸ºå‡¡é—´åŸæ± ï¼š{city_name}ï¼Œå¯¹åº”å¯†ç ï¼š{district_id}")
    else:
        print(f" è­¦ç¤ºï¼šæœªèƒ½è¯†åˆ«æ­¤åœ°åï¼š{city_name}")
        return {"message": f"âš ï¸  æœªèƒ½è¯†åˆ«åœ°ç‚¹ã€Œ{city_name}ã€\nå¯å°è¯•è¾“å…¥'åŒ—äº¬'ã€'ä¸Šæµ·'ç­‰åŸå¸‚ï¼Œæˆ–'ä¸œæµ·'ã€'é¾™å®«'ç­‰ä»™å¢ƒåœ°ç‚¹ã€‚"}
    
    # 3. è”æ¥å¤©åº­æ°”è±¡å°
    url = "https://api.map.baidu.com/weather/v1/"
    params = {
        "district_id": district_id,
        "data_type": "all",
        "ak": args.input.ak
    }
    
    try:
        # è·å–å¤©æ°”ä¿¡æ¯
        print(f"æ­£åœ¨ä¼ é€è‡³å¤©åº­æ°”è±¡å°...")
        response = requests.get(url=url, params=params)
        response.raise_for_status()
        raw_data = response.json()
        print(f"æˆåŠŸè·å–å¤©è±¡å·è½´ï¼çŠ¶æ€ï¼š{raw_data.get('status', 'æœªçŸ¥')}")
        
        if raw_data.get('status') != 0:
            error_msg = raw_data.get('message', 'æœªçŸ¥é”™è¯¯')
            print(f"å¤©åº­å›åº”é”™è¯¯ï¼š{error_msg}")
            return {"message": f"âš ï¸ ä¼ å›é”™è¯¯ï¼š{error_msg}\nå¤ªä¹™çœŸäººæç¤ºï¼šæ£€æŸ¥å¤©åº­ä»¤ç‰Œ(AK)æ˜¯å¦æ­£ç¡®"}
        
        # 4. ä¿¡æ¯æç‚¼
        print(f"æ­£åœ¨æç‚¼å¤©è±¡ç²¾å...")
        result = raw_data.get("result", {})
        location = result.get("location", {})
        current = result.get("now", {})
        forecasts = result.get("forecasts", [])
        
        # ç²¾é€‰ä¿¡æ¯
        weather_essence = {
            "åŸæ± ": location.get('name', city_name),
            "æ°”æ¸©": f"{current.get('temp', 'N/A')}Â°C",
            "å¤©è±¡": current.get('text', 'N/A'),
            "é£å‘": current.get('wind_dir', 'N/A'),
            "é£åŠ›": current.get('wind_class', 'N/A'),
            "æ¹¿åº¦": f"{current.get('rh', 'N/A')}%",
            "é¢„æµ‹": []
        }
        
        # æ·»åŠ æœªæ¥å¤©è±¡é¢„æµ‹
        print(f"æ­£åœ¨è§£ææœªæ¥{len(forecasts)}æ—¥å¤©è±¡...")
        for forecast in forecasts:
            future_weather = {
                "æ—¥æœŸ": forecast.get('date'),
                "æ˜ŸæœŸ": forecast.get('week'),
                "æ—¥é—´å¤©è±¡": forecast.get('text_day'),
                "å¤œé—´å¤©è±¡": forecast.get('text_night'),
                "æœ€é«˜æ¸©": forecast.get('high'),
                "æœ€ä½æ¸©": forecast.get('low'),
                "æ—¥é—´é£å‘": forecast.get('wd_day'),
                "æ—¥é—´é£åŠ›": forecast.get('wc_day')
            }
            weather_essence["é¢„æµ‹"].append(future_weather)
        
        # 5. ç¾åŒ–å±•ç¤º
        print(f"æ­£åœ¨ç»˜åˆ¶å¤©è±¡å·è½´...")
        weather_scroll = create_celestial_weather_scroll(weather_essence)
        
        return {"message": weather_scroll}
        
    except Exception as e:
        print(f"ã€å¤©æ°”ç¥é€šã€‘æ–½æ³•å¤±è´¥: {str(e)}")
        return {"message": f"âš ï¸ å¤©æ°”ç¥é€šæ–½æ³•å¤±è´¥: {str(e)}\nå¤ªä¹™çœŸäººæç¤ºï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä»¤ç‰Œæƒé™"}
```

![å®Œæˆçš„å¤©æ°”æ³•æœ¯](img/03_ç¼–å†™ä¸ä¼˜åŒ–å’’è¯­/image-20250313173347858.png)

## ä»™æ³•ä¿®ç‚¼ï¼šæ³•å®è¿›é˜¶æŒ‘æˆ˜

å¤ªä¹™çœŸäººç»™ä½ å¸ƒç½®äº†å‡ é¡¹è¿›é˜¶ä¿®ç‚¼ä»»åŠ¡ï¼š

1. **æ‰©å±•å¤©åœ°åå†Œ**ï¼š
   * æŒ‘æˆ˜ï¼šå°†åŸå¸‚åº“æ‰©å……è‡³å…¨å›½50ä¸ªä¸»è¦åŸå¸‚
   * æç¤ºï¼šå¯å‚è€ƒ[weather_district_idè¡¨](./weather_district_id.csv)

2. **å¼‚å¸¸é˜²æŠ¤**ï¼š
   * æŒ‘æˆ˜ï¼šå¢å¼ºä»£ç çš„å¼‚å¸¸å¤„ç†èƒ½åŠ›ï¼Œé˜²æ­¢æ„å¤–å´©æºƒ
   * æç¤ºï¼šä½¿ç”¨try/exceptæ•æ‰æ›´å¤šç±»å‹çš„é”™è¯¯

3. **ç¾åŒ–ç‰¹æ•ˆ**ï¼š
   * æŒ‘æˆ˜ï¼šä¸ºä¸åŒçš„ä»™å¢ƒåœ°ç‚¹æ·»åŠ ç‰¹æ®Šçš„å¤©æ°”æè¿°
   * æç¤ºï¼šä¾‹å¦‚ä¸œæµ·é¾™å®«å¯æ·»åŠ "æ°´æ³¢è¡æ¼¾"ç­‰æ°´ç³»ç‰¹æ•ˆ

4. **å¤©æ°”é¢„è­¦ç³»ç»Ÿ**ï¼š
   * æŒ‘æˆ˜ï¼šä»APIè¿”å›ä¸­æå–é¢„è­¦ä¿¡æ¯ï¼Œç”¨é†’ç›®æ–¹å¼æ˜¾ç¤º
   * æç¤ºï¼šè§£æalertså­—æ®µï¼Œç”¨çº¢è‰²å­—ç¬¦æˆ–ç‰¹æ®Šæ ‡è®°å¼ºè°ƒ

5. **ç¥å…µç»„åˆæŠ€**ï¼š
   * æŒ‘æˆ˜ï¼šè®¾è®¡ä¸€ä¸ª"å››æµ·é¾™ç‹è¡Œè¸ªé¢„æµ‹"åŠŸèƒ½
   * æç¤ºï¼šæ ¹æ®å››æµ·å¤©æ°”çŠ¶å†µï¼Œåˆ¤æ–­å“ªä½é¾™ç‹å¯èƒ½åœ¨å…´é£ä½œæµª

## ä»™é“æ€»ç»“ï¼šä»å‡¡æœ¯åˆ°ç¥é€š

é€šè¿‡è¿™æ¬¡æ¢ç´¢ï¼Œå“ªå’æˆåŠŸå°†ç®€å•çš„å¤©æ°”æŸ¥è¯¢æ³•æœ¯å‡çº§ä¸ºå¼ºå¤§çš„"å¤©æ°”ç¥é€š"ã€‚è¿™ä¸ªè¿›åŒ–è¿‡ç¨‹å±•ç°äº†ä¸‰å¤§æ³•å®çš„å¥‡å¦™ç»“åˆï¼š

1. **æ··å¤©ç»«ç‰µå¼•**ï¼šå°†æ™®é€šåŸå¸‚åè½¬åŒ–ä¸ºAPIéœ€è¦çš„ç¼–ç ï¼Œå®ç°è¯­è¨€è½¬æ¢
2. **é£ç«è½®ä¼ é€**ï¼šå¿«é€Ÿå¾€è¿”å¤©åº­æ°”è±¡å°ï¼Œè·å–æœ€æ–°å¤©æ°”æ•°æ®